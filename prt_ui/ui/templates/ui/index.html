<!DOCTYPE html>
{% load staticfiles %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Index</title>
    <link rel="stylesheet" href="{% static 'ui/js/jquery-ui.min.css' %}" >
    <script src="{% static 'ui/js/jquery.js' %}" ></script>
    <script src="{% static 'ui/js/jquery-ui.min.js' %}" ></script>
<style>

    .num_workers {
    -moz-column-count: 2;
    -moz-column-gap: 30px;
    -webkit-column-count: 2;
    -webkit-column-gap: 30px;

    column-count: 2;
    column-gap: 2vw;
        -webkit-column-fill: auto; /* Chrome, Safari, Opera */
    -moz-column-fill: auto; /* Firefox */
    column-fill: auto;
    height: 90vh;
    width: 95vw;
    overflow-y: auto;
    overflow-x: hidden;
    margin-left: 2vw;
    }

    .queues {
    -moz-column-count: 2;
    -moz-column-gap: 30px;
    -webkit-column-count: 2;
    -webkit-column-gap: 30px;
    column-count: 2;
    column-gap: 2vw;
        -webkit-column-fill: auto; /* Chrome, Safari, Opera */
    -moz-column-fill: auto; /* Firefox */
    column-fill: auto;
    overflow-y: auto;
    overflow-x: hidden;
    margin-left: 2vw;
    }

    .enjoy-css3 {
  -webkit-box-sizing: content-box;
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  float: right;

  top: 0;
  right: 5%;
  bottom: 0;
  left: 0;
  margin: 2% 0 2% 5%;
  overflow: scroll;
  border: 2px solid rgba(0,150,255,0.91);
  font: normal 17px/2 "Times New Roman", Times, serif;
  color: rgba(5,0,0,1);
    text-indent: 13px;
  text-align: justify;
  -o-text-overflow: ellipsis;
  text-overflow: ellipsis;
        width: 85%;
    height: 14vh;
    overflow: auto !important;
    border-style: solid;
    border-width: 5px !important;
}

    .enjoy-css2 {
  -webkit-box-sizing: content-box;
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  float: right;

  top: 0;
  right: 5%;
  bottom: 0;
  left: 0;
  margin: 2% 0 2% 5%;
  overflow: scroll;
  border: 2px solid rgba(0,150,255,0.91);
  font: normal 17px/2 "Times New Roman", Times, serif;
  color: rgba(5,0,0,1);
    text-indent: 13px;
  text-align: justify;
  -o-text-overflow: ellipsis;
  text-overflow: ellipsis;
        width: 95%;
    height: 17vh;
    overflow: auto !important;
    border-style: solid;
    border-width: 5px !important;
}

.enjoy-css {
  -webkit-box-sizing: content-box;
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  width: 45%;
  height: 10%;
  position: relative;
  top: 0;
  right: 5%;
  bottom: 0;
  left: 0;
  margin: 2% 0 0% 5%;

  overflow-y: scroll;
  border: 2px solid rgba(0,150,255,0.91);
  font: normal 15px/1 "Times New Roman", Times, serif;
  color: rgba(5,0,0,1);
  text-align: justify;
  -o-text-overflow: ellipsis;
  text-overflow: ellipsis;
    overflow: scroll !important;
  border-style: solid;
  border-width: 5px !important;
}

.resume_worker {
    position: relative;
    box-shadow: 0 4px 6.5px 0 rgba(0,0,0,.7), inset 0px -3px 1px 1px rgba(204,198,197,.5);
    }
.resume_worker:active {
    top: 2px;
    }
.resume_worker.active {
    top: 2px;
    box-shadow: 0 0.3px 0.7px 0 rgba(0,0,0,.4), inset 0px -3px 1px 1px rgba(204,198,197,.5);
    }

.pause_worker {
    position: relative;
    box-shadow: 0 4px 6.5px 0 rgba(0,0,0,.7), inset 0px -3px 1px 1px rgba(204,198,197,.5);
    }
.pause_worker:active {
    top: 2px;
    }
.pause_worker.active {
    top: 2px;
    box-shadow: 0 0.3px 0.7px 0 rgba(0,0,0,.4), inset 0px -3px 1px 1px rgba(204,198,197,.5);
    }

</style>
<script type="text/javascript">
(function($) {

    $.ajaxSetup({
        type: 'POST',
        timeout: 30000,
        error: function() {
            alert("timeout!");
                     }
    })

    $.fn.addWorker = function( options, callbackFunc ) {
        var settings = $.extend({site:null}, options);
        $.post("{% url 'ui:ajax_create_process' %}", {ajaxarg_site:settings.site, csrfmiddlewaretoken:'{{ csrf_token }}'},
        function(data,status){
            alert(data);
            $("#num_workers").load("{% url 'ui:ajax_auto_reload' %}", {ajaxarg_site: settings.site, csrfmiddlewaretoken:'{{ csrf_token }}'}, function(){
                $('#sites').trigger('custReady-Pause');
                $('#sites').trigger('custReady-Resume');
            });
        })
        .fail(function(){
            alert("error " + status );
        });
        return false;
    };

    $.fn.addToQ = function( options, callbackFunc ) {
        var settings = $.extend({site:null, proxy_name:null}, options);
        $.post("{% url 'ui:ajax_add_to_queue' %}", {ajaxarg_site:settings.site, ajaxarg_proxy_name:settings.proxy_name, csrfmiddlewaretoken:'{{ csrf_token }}'},
        function(data,status){
            alert(data);
            $("#num_workers").load("{% url 'ui:ajax_auto_reload' %}", {ajaxarg_site: settings.site, csrfmiddlewaretoken:'{{ csrf_token }}'}, function(){
                $('#sites').trigger('custReady-Pause');
                $('#sites').trigger('custReady-Resume');
            });
        })
        .fail(function(){
            alert("error " + status );
        });
        return false;
    };

    $.fn.pauseOrResumeWorker = function( options, callbackFunc ) {
        var settings = $.extend({site:null, pid:null, action:null}, options);
        $.post("{% url 'ui:ajax_pause_or_resume_worker' %}", {ajaxarg_site:settings.site, ajaxarg_pid:settings.pid,
                ajaxarg_action: settings.action, csrfmiddlewaretoken:'{{ csrf_token }}'},
        function(data,status){
            alert(data);
            $("#num_workers").load("{% url 'ui:ajax_auto_reload' %}", {ajaxarg_site: settings.site,
                csrfmiddlewaretoken:'{{ csrf_token }}'}, function(){
                    $('#sites').trigger('custReady-Pause');
                    $('#sites').trigger('custReady-Resume');
            });

        })
        .fail(function(){
            alert("error " + status );
        });
        return false;
    };


    $.fn.getQsStatus = function( options, callbackFunc ) {
        $("#queuess").load("{% url 'ui:ajax_get_preQs_status' %}", {csrfmiddlewaretoken:'{{ csrf_token }}'}, function(){
            $('#queues').dialog({
                modal:true,
                height: 100,
                width: 1000,
                buttons: {
                    Ok: function() {
                    $(this).dialog("close");
                    }
                }
            });
        });
    };


}(jQuery));
</script>
<script type="text/javascript">
$(document).ready(function(){

  $('#sites').on('custReady-Resume', function(){
    $(this).find('.resume_worker').filter(function() {
        return $(this).attr('data-pressed') != 'Paused';
    })
    .toggleClass('active');

  });


  $('#sites').on('custReady-Pause', function(){
    $(this).find('.pause_worker').filter(function() {
        return $(this).attr('data-pressed') == 'Paused';
    })
    .toggleClass('active');

  });

  $('#sites').trigger('custReady-Pause');
  $('#sites').trigger('custReady-Resume');

  $('#sites').on("click", ".pause_worker, .resume_worker", function(event){
    var target_button = event.target.id;
    var pressed = $("#"+target_button).attr("data-pressed");
    var button_class = $("#"+target_button).attr("class").split(" ")[0];
    if ((button_class == "pause_worker" && pressed == "Paused") ||
      (button_class == "resume_worker" && pressed != "Paused")) {
        return false;
    }
    $("#"+target_button).toggleClass('active');
    $("#"+target_button).attr("data-pressed", "Paused");
    var site_name = $("#"+target_button).closest("div").attr("id");
    var pid = $("#"+target_button).attr("value");
    var action = $("#"+target_button).attr("class").split(" ")[0];
    $("#"+target_button).pauseOrResumeWorker({site: site_name, pid: pid, action: action}, function(){
    });


  });

  $("#sites").on("click", ".Add-Worker", function(){
    var lock = $(".Add-Worker").attr("data-locked");
    if (lock == "True") {
        return false;
    }
    $(".Add-Worker").attr('data-locked', "True");
    var site_name = $(this).closest("div").attr("id");
        $(this).addWorker({site: site_name}, function(){
        });

  });
  $("#sites").on("click", ".Add-To-Q", function(event){
    var lock = $(".Add-To-Q").attr("data-locked");
    if (lock == "True") {
        return false;
    }
    $(".Add-To-Q").attr('data-locked', "True");
    var site_name = $(this).closest("div").attr("id");
    var target_button = event.target.id;
    var proxy_name = $("#"+target_button).siblings("select").find("option:selected").attr("value");
        $(this).addToQ({site: site_name, proxy_name: proxy_name}, function(){
        });

  });


   $(".show_queues").on("click", function() {
        $("#queues").load("{% url 'ui:ajax_get_preQs_status' %}", {csrfmiddlewaretoken:'{{ csrf_token }}'}, function(){
            $('#queues').dialog({
                modal:true,
                width: 1200,
                height: 850,
                buttons: {
                    Ok: function() {
                    $(this).dialog("close");
                    }
                }
            });
        });
   });


    if (1 == 2) {
    $("#test_dialog").dialog({

        modal:true,
        buttons: {
            Ok: function() {
                $(this).dialog("close");
            }
        }

    });
    }


});
</script>
</head>
<body>

<p>Welcome to PRT!</p>
<button class="show_queues"> Show Queues</button>
<div id="queues" class="queues" >
</div>
<div id="test_dialog">
</div>
<div  id="sites">
<div id="num_workers" class="num_workers">
{% for site, site_hash in active_workers.items %}
<div id="{{site}}" class="enjoy-css2">
    <button  style="margin-top:0" id="addWorker-{{site}}" data-locked="False" class="Add-Worker"> Add Worker   </button>
    <button  style="margin-top:0" id="addToQ-{{site}}"  data-locked="False" class="Add-To-Q"> Add To Queue   </button>
    <select name="proxies" id="proxies">
        {% for proxy_name in site_hash.proxies %}
            <option value="{{proxy_name}}">{{proxy_name}}</option>
        {% endfor %}
    </select>
<h3 class="text_data">{{site}}: {{site_hash.active_workers}} active workers</h3>
<ul>
    {% for pid, proc_hash in site_hash.workers.items %}
        <li>{{pid}} - status: {{proc_hash.status}}, currently working on: {{proc_hash.working_on}}, step: {{proc_hash.step}}
        <button  style="margin-right:2px" id="{{pid}}-start" value="{{pid}}" data-pressed="{{proc_hash.status}}" class="resume_worker">&#9658;</button>
        <button  style="margin-top:0" id="{{pid}}-pause" value="{{pid}}" data-pressed="{{proc_hash.status}}" class="pause_worker">&#9646;&#9646;</button></li>
    {% endfor %}
</ul>


</div>
{% endfor %}
</div>


</div>
</body>
</html>